<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mybatis.mapper.product">

	<sql id="searchKeyword">
		<choose>
			<when test='keyword!=null and keyword!=""'>
				AND PRODUCT_NAME LIKE '%'||#{keyword}||'%'
				OR PRODUCT_TAG LIKE '%'||#{keyword}||'%'
			</when>
			<otherwise>
				AND PRODUCT_CATEGORY1_NO = #{category1}
				<if test='category2!=null and category2!=""'>
					AND PRODUCT_CATEGORY2_NO = #{category2} 
				</if>
			</otherwise>
		</choose>
	</sql>


	<sql id="searchProductState">
		<choose>
			<when test='option=="2"'>
				AND PRODUCT_STATE_NO IN(1, 2)
			</when>
			<when test='option=="3"'>
				AND PRODUCT_STATE_NO IN(1, 3)
			</when>
			<when test='option=="5"'>
				AND PRODUCT_STATE_NO IN(1, 2, 3)
			</when>
			<otherwise>
				AND PRODUCT_STATE_NO = 1
			</otherwise>
		</choose>
	</sql>


	<sql id="searchCategory">
		AND PRODUCT_CATEGORY1_NO = #{category1}
		<if test='category2!=null and category2!=""'>
			AND PRODUCT_CATEGORY2_NO = #{category2} 
		</if>
	</sql>


	<!-- 메인 상품 전체 출력 -->
	<select id="searchMainProduct" resultType="productDto">
		<![CDATA[
		SELECT product_no, product_name, product_price, product_img_uuid, product_regdate FROM product_view
		WHERE rownum <= 30
		]]>
	</select>


	<!-- 상품 대분류 출력 -->
	<select id="searchProductCategory1" resultType="productCategoryDto">
		SELECT*FROM product_category1
		ORDER BY PRODUCT_CATEGORY1_NO
	</select>
	
	
	<!-- 상품 소분류 출력 -->
	<select id="searchProductCategory2" parameterType="int" resultType="productCategoryDto">
		SELECT*FROM product_category2
		WHERE PRODUCT_CATEGORY1_NO=#{PRODUCT_CATEGORY1_NO}
		ORDER BY PRODUCT_CATEGORY2_NO
	</select>
	
	
	<!-- 분류별 상품 출력 -->
	<select id="searchProductByCategory" parameterType="searchCondition" resultType="productDto">
		SELECT product_no, product_state_no, product_name, product_price, product_img_uuid, product_regdate 
		FROM
		(
			SELECT ROWNUM NUM, A.* 
			FROM
			(
				SELECT product_no, product_state_no, product_name, product_price, product_img_uuid, product_regdate 
				FROM product_view
				WHERE MEMBER_STATE_NO=1
				<include refid="searchProductState" />
				<include refid="searchKeyword" />
				ORDER BY product_regdate DESC, product_no DESC	
			)A
		)
		WHERE NUM BETWEEN #{startPage} AND #{endPage}
	</select>
	
	
	<select id="searchProductCount" parameterType="searchCondition" resultType="int">
		SELECT COUNT(*)
		FROM product_view
		WHERE MEMBER_STATE_NO=1 
		<include refid="searchProductState" />
		<include refid="searchKeyword" />
	</select>
</mapper>