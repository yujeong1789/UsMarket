<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mybatis.mapper.admin">

	<sql id="searchCondition">
		<choose>
			<when test="condition == 1">
				AND member_state_no = 1
			</when>
			<when test="condition == 2">
				AND member_state_no = 2
			</when>
			<when test="condition == 3">
				AND member_state_no = 3
			</when>
		</choose>
	</sql>
	
	<sql id="searchOrder">
		<choose>
			<when test="order == 'regdate'">
				ORDER BY m.member_regdate
			</when>
			<when test="order == 'product'">
				ORDER BY product_count
			</when>
			<when test="order == 'product_desc'">
				ORDER BY product_count DESC
			</when>
			<otherwise>
				ORDER BY m.member_regdate DESC
			</otherwise>
		</choose>
	</sql>

	<select id="searchAdmin" parameterType="map" resultType="map">
		SELECT admin_no, admin_id, admin_name FROM admin 
		WHERE admin_id = #{admin_id} AND admin_password = #{admin_password}
	</select>
	
	<select id="searchMemberStatsByDate" parameterType="adminSearchCondition" resultType="map">
		SELECT *
		FROM member_stats_date
		WHERE TO_DATE("DATE", 'YYYY-MM-DD') BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD')
	</select>
	
	<select id="searchMemberStatsByMonth" parameterType="adminSearchCondition" resultType="map">
		SELECT *
		FROM member_stats_month
		WHERE TO_DATE("DATE", 'YYYY-MM') BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD')
	</select>

	<select id="searchMemberList" parameterType="adminSearchCondition" resultType="map">
		SELECT *
		FROM ( SELECT rownum AS num, A.*
			   FROM ( SELECT m.member_no
						, m.member_name
						, m.member_nickname
						, m.member_id
						, m.member_regdate
						, m.member_state_no
						, ms.member_state_name 
						, ( SELECT COUNT(*) 
							FROM product p 
							WHERE p.seller_no = m.member_no
					  	  ) AS product_count
			   		  FROM MEMBER m, member_state ms
			   		  WHERE m.member_state_no = ms.member_state_no
					  <choose>
					  	<when test="condition == 1">
							AND m.member_state_no = 1 
						</when>
						<when test="condition == 2">
							AND m.member_state_no = 2 
						</when>
						<when test="condition == 3">
							AND m.member_state_no = 3 
						</when>
					  </choose>
					  AND m.member_regdate BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD')+1
					  <include refid="searchOrder" />
			 		) A
			 )
		WHERE num BETWEEN #{startPage} AND #{endPage}
	</select>
	
	<select id="searchMemberCnt" parameterType="map" resultType="int">
		SELECT COUNT(*)
		FROM MEMBER
		WHERE member_regdate BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD')+1
		<include refid="searchCondition" /> 
	</select>
	
	<select id="searchMemberInfo" parameterType="string" resultType="map">
		SELECT m.member_no
			 , m.member_name
			 , m.member_nickname
			 , m.member_id
			 , m.member_image
			 , m.member_email
			 , m.member_regdate
			 , m.member_zipcode
			 , m.member_address
			 , m.member_address_detail
			 , m.member_state_no
			 , ms.member_state_name
		FROM member m, member_state ms
		WHERE m.member_state_no = ms.member_state_no 
		AND member_no = #{member_no}
	</select>
 
 	<select id="searchMemberProductList" parameterType="adminSearchCondition" resultType="map">
		SELECT * 
		FROM ( SELECT rownum AS num, A.*
			   FROM ( SELECT*
					  FROM product_view
					  WHERE seller_no = #{member_no}
					  AND product_state_no != 4 
					  <choose>
					  	<when test="condition == 1">
							AND product_state_no = 1 
						</when>
						<when test="condition == 2">
							AND product_state_no = 2  
						</when>
						<when test="condition == 3">
							AND product_state_no = 3  
						</when>
					  </choose> 
					  <choose>
					  	<when test="order == 'regdate_desc'">
							ORDER BY product_regdate DESC 
						</when>
						<when test="order == 'regdate'">
							ORDER BY product_regdate  
						</when>
						<when test="order == 'view_desc'">
							ORDER BY product_view DESC 
						</when>
						<when test="order == 'view'">
							ORDER BY product_view 
						</when>
						<otherwise>
							ORDER BY product_regdate DESC 
						</otherwise>
					  </choose>
					) A
			 )
		WHERE num BETWEEN #{startPage} AND #{endPage}
	</select>
		
	<select id="searchMemberProductCnt" parameterType="map" resultType="int">
		SELECT COUNT(*)
		FROM product_view
		WHERE seller_no = #{member_no}
		AND product_state_no != 4 
		<choose>
			<when test="condition == 1">
				AND product_state_no = 1 
			</when>
			<when test="condition == 2">
				AND product_state_no = 2  
			</when>
			<when test="condition == 3">
				AND product_state_no = 3  
			</when>
		</choose> 
	</select>
		
	<select id="searchDealStatsByDate" parameterType="adminSearchCondition" resultType="map">
		SELECT *
		FROM deal_stats_date
		WHERE TO_DATE(day, 'YYYY-MM-DD') BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD')+1
	</select>
	
	<select id="searchDealStatsByMonth" parameterType="adminSearchCondition" resultType="map">
		SELECT *
		FROM deal_stats_month
		WHERE TO_DATE(day, 'YYYY-MM') BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD')+1
	</select>
	
	<select id="searchDealList" parameterType="adminSearchCondition" resultType="map">
		SELECT*
		FROM ( SELECT rownum AS num, A.*
			   FROM ( SELECT p.product_price, d.*
					  FROM deal d, product p
					  WHERE d.product_no = p.product_no
					  AND d.deal_start_date BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD')+1
					  <choose>
					  	<when test="condition == 1">
							AND d.deal_state = 1 
						</when>
					  	<when test="condition == 2">
							AND d.deal_state = 2 
						</when>
					  	<when test="condition == 3">
							AND d.deal_state = 3 
						</when>
					  </choose>
					  <choose>
					  	<when test="order == 'regdate'">
							ORDER BY d.deal_start_date 
						</when>
					  	<when test="order == 'price_desc'">
							ORDER BY p.product_price DESC 
						</when>
					  	<when test="order == 'price'">
							ORDER BY p.product_price 
						</when>
						<otherwise>
							ORDER BY d.deal_start_date DESC 
						</otherwise>
					  </choose>
					) A
			 )
		WHERE num BETWEEN #{startPage} AND #{endPage}
	</select>
	
	<select id="searchDealCnt" parameterType="map" resultType="int">
		SELECT COUNT(*)
		FROM deal
		WHERE deal_start_date BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') AND TO_DATE(#{endDate}, 'YYYY-MM-DD')+1
		<choose>
			<when test="condition == 1">
				AND deal_delivery_state = 1 
			</when>
			<when test="condition == 2">
				AND deal_delivery_state = 2 
			</when>
			<when test="condition == 3">
				AND deal_delivery_state = 3 
			</when>
		</choose>
	</select>
	
	<select id="searchDealInfo" resultType="map" parameterType="string">
		SELECT (SELECT member_name FROM MEMBER m WHERE m.member_no = d.seller_no) AS seller_name
				, p.product_name
				, p.product_price
				, d.*
		FROM deal d, product p
		WHERE d.product_no = p.product_no
		AND d.deal_no = #{deal_no}
	</select>
	
	<select id="searchReviewInfo" resultType="map" parameterType="string">
		SELECT d.customer_no
			   , m.member_nickname
			   , m.member_image
			   , r.*
		FROM review r, deal d, member m
		WHERE r.deal_no = d.deal_no
		AND d.customer_no = m.member_no
		AND d.deal_no = #{deal_no}
	</select>
	
	<select id="searchReportList" parameterType="map" resultType="map">
		SELECT *
		FROM ( SELECT rownum AS num, A.*
				FROM (	SELECT r.report_no, r.report_regdate, r.report_complete
							,( SELECT c1.report_category1_name FROM report_category1 c1
							   WHERE c1.report_category1_no = r.report_category1_no
							 )||' | '||
							 ( SELECT c2.report_category2_name FROM report_category2 c2
							   WHERE c2.report_category1_no = r.report_category1_no AND c2.report_category2_no = r.report_category2_no
							 ) AS report_title
						FROM report r
						ORDER BY report_regdate DESC
					 ) A
			 )
		WHERE num BETWEEN #{startPage} AND #{endPage}
	</select>
	
	
	<select id="searchQnaList" parameterType="map" resultType="map">
		SELECT *
		FROM ( SELECT rownum AS num, A.*
				FROM (	SELECT qna_no, qna_title, qna_complete, qna_regdate
						FROM qna
						ORDER BY qna_regdate DESC
					 ) A
			 )
		WHERE num BETWEEN #{startPage} AND #{endPage}
	</select>
</mapper>